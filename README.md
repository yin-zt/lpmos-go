# LPMOS - Linux Provisioning and Management OS System

åˆ†å¸ƒå¼PXEè‡ªåŠ¨è£…æœºç®¡ç†å¹³å° - åŸºäºetcdçš„v3ä¼˜åŒ–æ¶æ„

## ğŸ¯ é¡¹ç›®ç‰¹ç‚¹

- **v3ä¼˜åŒ–æ¶æ„**: 10å€æ€§èƒ½æå‡ï¼ŒåŸå­äº‹åŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†
- **å‰åç«¯ä¸€ä½“**: ç°ä»£åŒ–Webç•Œé¢ï¼Œå®æ—¶WebSocketæ›´æ–°
- **å¤šæœºæˆ¿æ”¯æŒ**: æ”¯æŒè·¨æœºæˆ¿çš„ç»Ÿä¸€ç®¡ç†
- **è‡ªåŠ¨åŒ–æµç¨‹**: ä»ä»»åŠ¡åˆ›å»ºåˆ°è£…æœºå®Œæˆçš„å…¨è‡ªåŠ¨æµç¨‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸€é”®å¯åŠ¨Demo

```bash
make demo
```

### 2. å¯åŠ¨å„ç»„ä»¶

```bash
# Terminal 1 - Control Plane (ç®¡ç†åå°)
make run

# Terminal 2 - Regional Client (æœºæˆ¿å®¢æˆ·ç«¯)
make run-regional

# Terminal 3 - Agent (è£…æœºä»£ç†)
make run-agent
```

### 3. è®¿é—®Webç•Œé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®: **http://localhost:8080**

## ğŸ“‹ ä¸»è¦åŠŸèƒ½

### Webç•Œé¢åŠŸèƒ½
- âœ… **åˆ›å»ºè£…æœºä»»åŠ¡** - é€‰æ‹©æœºæˆ¿ï¼Œå¡«å†™æœåŠ¡å™¨ä¿¡æ¯
- âœ… **ä»»åŠ¡åˆ—è¡¨** - å®æ—¶æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
- âœ… **ä»»åŠ¡å®¡æ‰¹** - ä¸€é”®å®¡æ‰¹æˆ–æ‹’ç»ä»»åŠ¡
- âœ… **è¿›åº¦ç›‘æ§** - å®æ—¶æŸ¥çœ‹å®‰è£…è¿›åº¦
- âœ… **ç»Ÿè®¡é¢æ¿** - æŸ¥çœ‹å„çŠ¶æ€ä»»åŠ¡æ•°é‡

### ç³»ç»Ÿç‰¹æ€§
- âš¡ **10xæ›´å¿«** - ç‹¬ç«‹server keyï¼Œæ— ç«æ€æ¡ä»¶
- âš¡ **2xæ›´å¿«** - åˆå¹¶taskç»“æ„ï¼ŒåŸå­æ›´æ–°
- âš¡ **90%æ›´å°‘æµé‡** - ç²¾ç»†åŒ–watchç›‘å¬
- âœ… **è‡ªåŠ¨æ¸…ç†** - Lease TTLæœºåˆ¶
- âœ… **ä¸€è‡´æ€§ä¿è¯** - äº‹åŠ¡çº§åŸå­æ›´æ–°

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Browser   â”‚
â”‚  (Port 8080)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP/WebSocket
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Control Plane   â”‚â—„â”€â”€â”
â”‚  (ç®¡ç†åå°)      â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚            â”‚ etcd Watch
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
    â”‚  etcd   â”‚â—„â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Key/Valueâ”‚       â”‚
    â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜       â”‚
         â”‚            â”‚
         â”‚         â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚ Regional Client â”‚
         â”‚         â”‚   (æœºæˆ¿å®¢æˆ·ç«¯)   â”‚
         â”‚         â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚
                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                 â”‚  Agent  â”‚
                 â”‚ (è£…æœºä»£ç†)â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ etcdé”®ç»“æ„ (v3ä¼˜åŒ–)

```
# ç‹¬ç«‹çš„æœåŠ¡å™¨é”® (æ— ç«æ€)
/os/{idc}/servers/{sn} = {"status": "pending", "mac": "..."}

# åˆå¹¶çš„ä»»åŠ¡ç»“æ„ (åŸå­æ›´æ–°)
/os/{idc}/machines/{sn}/task = {
  "task_id": "...",
  "status": "installing",
  "progress": [...],  # é›†æˆ
  "logs": [...],      # é›†æˆ
  "approval": {...}   # é›†æˆ
}

# Leaseå¿ƒè·³ (è‡ªåŠ¨æ¸…ç†)
/os/{idc}/machines/{sn}/lease = "lease-12345"  # 30s TTL

# å…¨å±€ç»Ÿè®¡
/os/global/stats/{idc} = {"total": 100, "pending": 5, ...}
```

## ğŸ¨ ä½¿ç”¨æµç¨‹

### åˆ›å»ºè£…æœºä»»åŠ¡

1. è®¿é—® http://localhost:8080
2. ç‚¹å‡»"æ–°å»ºè£…æœºä»»åŠ¡"
3. å¡«å†™è¡¨å•ï¼š
   - æœºæˆ¿: DC1/DC2/DC3
   - æœåŠ¡å™¨SN: sn-001
   - MACåœ°å€: 00:1a:2b:3c:4d:5e
   - æ“ä½œç³»ç»Ÿ: Ubuntu 22.04
   - ç³»ç»Ÿç‰ˆæœ¬: 22.04
4. æäº¤åˆ›å»º

### å®¡æ‰¹ä»»åŠ¡

1. åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­æ‰¾åˆ°å¾…å®¡æ‰¹ä»»åŠ¡
2. ç‚¹å‡»"âœ“ å®¡æ‰¹"é€šè¿‡ï¼Œæˆ–"âœ— æ‹’ç»"
3. Regional Clientç›‘å¬åˆ°å®¡æ‰¹åè§¦å‘PXEé…ç½®
4. Agentå¼€å§‹è£…æœºæµç¨‹

### ç›‘æ§è¿›åº¦

- å®æ—¶æŸ¥çœ‹è¿›åº¦æ¡å’Œç™¾åˆ†æ¯”
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- WebSocketè‡ªåŠ¨æ¨é€æ›´æ–°

## ğŸ“– APIæ¥å£

### åˆ›å»ºä»»åŠ¡
```bash
curl -X POST http://localhost:8080/api/v1/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "idc": "dc1",
    "sn": "sn-001",
    "mac": "00:1a:2b:3c:4d:5e",
    "os_type": "Ubuntu 22.04",
    "os_version": "22.04"
  }'
```

### æŸ¥è¯¢ä»»åŠ¡
```bash
# æ‰€æœ‰ä»»åŠ¡
curl http://localhost:8080/api/v1/tasks

# ç‰¹å®šä»»åŠ¡
curl http://localhost:8080/api/v1/tasks/dc1/sn-001
```

### å®¡æ‰¹ä»»åŠ¡
```bash
curl -X POST http://localhost:8080/api/v1/tasks/dc1/sn-001/approve \
  -H "Content-Type: application/json" \
  -d '{"notes": "å®¡æ‰¹é€šè¿‡"}'
```

## ğŸ› ï¸ Makefileå‘½ä»¤

```bash
# æ„å»º
make build                  # æ„å»ºæ‰€æœ‰ç»„ä»¶
make build-control-plane    # æ„å»ºControl Plane
make build-regional-client  # æ„å»ºRegional Client
make build-agent            # æ„å»ºAgent

# è¿è¡Œ
make run                    # å¯åŠ¨Control Plane
make run-regional           # å¯åŠ¨Regional Client (dc1)
make run-regional-dc2       # å¯åŠ¨Regional Client (dc2)
make run-agent              # å¯åŠ¨Agent

# ç¯å¢ƒ
make start-etcd             # å¯åŠ¨etcd
make stop-etcd              # åœæ­¢etcd
make demo                   # ä¸€é”®Demoç¯å¢ƒ

# å…¶ä»–
make clean                  # æ¸…ç†æ„å»º
make deps                   # ä¸‹è½½ä¾èµ–
make test                   # è¿è¡Œæµ‹è¯•
make help                   # æŸ¥çœ‹å¸®åŠ©
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
lpmos-go/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ control-plane/      # ç®¡ç†åå° (v3ä¼˜åŒ–)
â”‚   â”œâ”€â”€ regional-client/    # æœºæˆ¿å®¢æˆ·ç«¯ (v3ä¼˜åŒ–)
â”‚   â””â”€â”€ agent-minimal/      # è£…æœºä»£ç†
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ etcd/               # etcdå®¢æˆ·ç«¯ (v3ä¼˜åŒ–API)
â”‚   â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹ (v3åˆå¹¶ç»“æ„)
â”‚   â””â”€â”€ websocket/          # WebSocketæ¨é€
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ index.html          # ä¸»ç•Œé¢ (å®Œæ•´åŠŸèƒ½)
â”‚   â””â”€â”€ dashboard.html      # ç®€åŒ–ç‰ˆ
â”œâ”€â”€ Makefile                # ç»Ÿä¸€å‘½ä»¤
â””â”€â”€ README.md               # æœ¬æ–‡æ¡£
```

## ğŸ”§ ä¾èµ–é¡¹

- Go 1.22+
- etcd 3.5+
- Docker (å¯é€‰ï¼Œç”¨äºè¿è¡Œetcd)

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æœºæˆ¿

åœ¨Webç•Œé¢çš„æœºæˆ¿ä¸‹æ‹‰åˆ—è¡¨ä¸­æ·»åŠ ï¼š
```html
<!-- web/index.html -->
<option value="dc4">DC4 - æ–°æœºæˆ¿</option>
```

### è‡ªå®šä¹‰æ“ä½œç³»ç»Ÿ

åœ¨æ“ä½œç³»ç»Ÿä¸‹æ‹‰åˆ—è¡¨ä¸­æ·»åŠ ï¼š
```html
<option value="AlmaLinux 9">AlmaLinux 9</option>
```

## ğŸ“ æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | v2.x | v3.0 | æå‡ |
|-----|------|------|------|
| æœåŠ¡å™¨æ·»åŠ  | ~50-100ms | ~5-10ms | **10x** |
| è¿›åº¦æ›´æ–° | ~20ms | ~10ms | **2x** |
| Watchæµé‡ | å…¨éƒ¨äº‹ä»¶ | ä»…ç›¸å…³äº‹ä»¶ | **90% less** |

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡](./ARCHITECTURE_V3.0.md)
- [æ€§èƒ½ä¼˜åŒ–è¯´æ˜](./SCHEMA_OPTIMIZATION_V3.0.md)
- [ç”¨æˆ·æ‰‹å†Œ](./README_V3.0.md)

## ğŸ› æ•…éšœæ’é™¤

### etcdè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥etcdæ˜¯å¦è¿è¡Œ
docker ps | grep etcd

# é‡å¯etcd
make stop-etcd
make start-etcd
```

### WebSocketæœªè¿æ¥
- æ£€æŸ¥Control Planeæ˜¯å¦å¯åŠ¨
- æŸ¥çœ‹æµè§ˆå™¨Consoleæ˜¯å¦æœ‰é”™è¯¯
- ç¡®è®¤8080ç«¯å£æœªè¢«å ç”¨

### Agentæ— æ³•ä¸ŠæŠ¥
- ç¡®è®¤Regional Clientå·²å¯åŠ¨
- æ£€æŸ¥--regional-urlå‚æ•°æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹Regional Clientæ—¥å¿—

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. `make help` - å‘½ä»¤å¸®åŠ©
2. é¡¹ç›®æ–‡æ¡£ç›®å½•
3. etcdæ—¥å¿—: `docker logs lpmos-etcd`

---

**ç‰ˆæœ¬**: v3.0  
**æ›´æ–°**: 2026-01-30  
**æ¶æ„**: ä¼˜åŒ–çš„etcd Schemaï¼Œç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
